!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","./cssScanner","./cssNodes","./cssErrors","../languageFacts/facts"],e)}((function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=e("./cssScanner"),i=e("./cssNodes"),s=e("./cssErrors"),n=e("../languageFacts/facts"),o=function(){function e(e){void 0===e&&(e=new r.Scanner),this.keyframeRegex=/^@(\-(webkit|ms|moz|o)\-)?keyframes$/i,this.scanner=e,this.token=null,this.prevToken=null}return e.prototype.peekIdent=function(e){return r.TokenType.Ident===this.token.type&&e.length===this.token.text.length&&e===this.token.text.toLowerCase()},e.prototype.peekKeyword=function(e){return r.TokenType.AtKeyword===this.token.type&&e.length===this.token.text.length&&e===this.token.text.toLowerCase()},e.prototype.peekDelim=function(e){return r.TokenType.Delim===this.token.type&&e===this.token.text},e.prototype.peek=function(e){return e===this.token.type},e.prototype.peekRegExp=function(e,t){return e===this.token.type&&t.test(this.token.text)},e.prototype.hasWhitespace=function(){return this.prevToken&&this.prevToken.offset+this.prevToken.len!==this.token.offset},e.prototype.consumeToken=function(){this.prevToken=this.token,this.token=this.scanner.scan()},e.prototype.mark=function(){return{prev:this.prevToken,curr:this.token,pos:this.scanner.pos()}},e.prototype.restoreAtMark=function(e){this.prevToken=e.prev,this.token=e.curr,this.scanner.goBackTo(e.pos)},e.prototype.try=function(e){var t=this.mark(),r=e();return r||(this.restoreAtMark(t),null)},e.prototype.acceptOneKeyword=function(e){if(r.TokenType.AtKeyword===this.token.type)for(var t=0,i=e;t<i.length;t++){var s=i[t];if(s.length===this.token.text.length&&s===this.token.text.toLowerCase())return this.consumeToken(),!0}return!1},e.prototype.accept=function(e){return e===this.token.type&&(this.consumeToken(),!0)},e.prototype.acceptIdent=function(e){return!!this.peekIdent(e)&&(this.consumeToken(),!0)},e.prototype.acceptKeyword=function(e){return!!this.peekKeyword(e)&&(this.consumeToken(),!0)},e.prototype.acceptDelim=function(e){return!!this.peekDelim(e)&&(this.consumeToken(),!0)},e.prototype.acceptUnquotedString=function(){var e=this.scanner.pos();this.scanner.goBackTo(this.token.offset);var t=this.scanner.scanUnquotedString();return t?(this.token=t,this.consumeToken(),!0):(this.scanner.goBackTo(e),!1)},e.prototype.resync=function(e,t){for(;;){if(e&&-1!==e.indexOf(this.token.type))return this.consumeToken(),!0;if(t&&-1!==t.indexOf(this.token.type))return!0;if(this.token.type===r.TokenType.EOF)return!1;this.token=this.scanner.scan()}},e.prototype.createNode=function(e){return new i.Node(this.token.offset,this.token.len,e)},e.prototype.create=function(e){return new e(this.token.offset,this.token.len)},e.prototype.finish=function(e,t,r,s){if(!(e instanceof i.Nodelist)&&(t&&this.markError(e,t,r,s),null!==this.prevToken)){var n=this.prevToken.offset+this.prevToken.len;e.length=n>e.offset?n-e.offset:0}return e},e.prototype.markError=function(e,t,r,s){this.token!==this.lastErrorToken&&(e.addIssue(new i.Marker(e,t,i.Level.Error,null,this.token.offset,this.token.len)),this.lastErrorToken=this.token),(r||s)&&this.resync(r,s)},e.prototype.parseStylesheet=function(e){var t=e.version;return this.internalParse(e.getText(),this._parseStylesheet,(function(r,i){if(e.version!==t)throw new Error("Underlying model has changed, AST is no longer valid");return e.getText().substr(r,i)}))},e.prototype.internalParse=function(e,t,r){this.scanner.setSource(e),this.token=this.scanner.scan();var i=t.bind(this)();return i&&(i.textProvider=r||function(t,r){return e.substr(t,r)}),i},e.prototype._parseStylesheet=function(){var e=this.create(i.Stylesheet);e.addChild(this._parseCharset());var t=!1;do{var n=!1;do{n=!1;var o=this._parseStylesheetStatement();for(o&&(e.addChild(o),n=!0,t=!1,this.peek(r.TokenType.EOF)||!this._needsSemicolonAfter(o)||this.accept(r.TokenType.SemiColon)||this.markError(e,s.ParseError.SemiColonExpected));this.accept(r.TokenType.SemiColon)||this.accept(r.TokenType.CDO)||this.accept(r.TokenType.CDC);)n=!0,t=!1}while(n);if(this.peek(r.TokenType.EOF))break;t||(this.peek(r.TokenType.AtKeyword)?this.markError(e,s.ParseError.UnknownAtRule):this.markError(e,s.ParseError.RuleOrSelectorExpected),t=!0),this.consumeToken()}while(!this.peek(r.TokenType.EOF));return this.finish(e)},e.prototype._parseStylesheetStatement=function(e){return void 0===e&&(e=!1),this.peek(r.TokenType.AtKeyword)?this._parseStylesheetAtStatement(e):this._parseRuleset(e)},e.prototype._parseStylesheetAtStatement=function(e){return void 0===e&&(e=!1),this._parseImport()||this._parseMedia(e)||this._parsePage()||this._parseFontFace()||this._parseKeyframe()||this._parseSupports(e)||this._parseViewPort()||this._parseNamespace()||this._parseDocument()||this._parseUnknownAtRule()},e.prototype._tryParseRuleset=function(e){var t=this.mark();if(this._parseSelector(e)){for(;this.accept(r.TokenType.Comma)&&this._parseSelector(e););if(this.accept(r.TokenType.CurlyL))return this.restoreAtMark(t),this._parseRuleset(e)}return this.restoreAtMark(t),null},e.prototype._parseRuleset=function(e){void 0===e&&(e=!1);var t=this.create(i.RuleSet),n=t.getSelectors();if(!n.addChild(this._parseSelector(e)))return null;for(;this.accept(r.TokenType.Comma);)if(!n.addChild(this._parseSelector(e)))return this.finish(t,s.ParseError.SelectorExpected);return this._parseBody(t,this._parseRuleSetDeclaration.bind(this))},e.prototype._parseRuleSetDeclaration=function(){return this._parseAtApply()||this._tryParseCustomPropertyDeclaration()||this._parseDeclaration()||this._parseUnknownAtRule()},e.prototype._parseAtApply=function(){if(!this.peekKeyword("@apply"))return null;var e=this.create(i.AtApplyRule);return this.consumeToken(),e.setIdentifier(this._parseIdent([i.ReferenceType.Variable]))?this.finish(e):this.finish(e,s.ParseError.IdentifierExpected)},e.prototype._needsSemicolonAfter=function(e){switch(e.type){case i.NodeType.Keyframe:case i.NodeType.ViewPort:case i.NodeType.Media:case i.NodeType.Ruleset:case i.NodeType.Namespace:case i.NodeType.If:case i.NodeType.For:case i.NodeType.Each:case i.NodeType.While:case i.NodeType.MixinDeclaration:case i.NodeType.FunctionDeclaration:return!1;case i.NodeType.ExtendsReference:case i.NodeType.MixinContent:case i.NodeType.ReturnStatement:case i.NodeType.MediaQuery:case i.NodeType.Debug:case i.NodeType.Import:case i.NodeType.AtApplyRule:case i.NodeType.CustomPropertyDeclaration:return!0;case i.NodeType.VariableDeclaration:return e.needsSemicolon;case i.NodeType.MixinReference:return!e.getContent();case i.NodeType.Declaration:return!e.getNestedProperties()}return!1},e.prototype._parseDeclarations=function(e){var t=this.create(i.Declarations);if(!this.accept(r.TokenType.CurlyL))return null;for(var n=e();t.addChild(n)&&!this.peek(r.TokenType.CurlyR);){if(this._needsSemicolonAfter(n)&&!this.accept(r.TokenType.SemiColon))return this.finish(t,s.ParseError.SemiColonExpected,[r.TokenType.SemiColon,r.TokenType.CurlyR]);for(;this.accept(r.TokenType.SemiColon););n=e()}return this.accept(r.TokenType.CurlyR)?this.finish(t):this.finish(t,s.ParseError.RightCurlyExpected,[r.TokenType.CurlyR,r.TokenType.SemiColon])},e.prototype._parseBody=function(e,t){return e.setDeclarations(this._parseDeclarations(t))?this.finish(e):this.finish(e,s.ParseError.LeftCurlyExpected,[r.TokenType.CurlyR,r.TokenType.SemiColon])},e.prototype._parseSelector=function(e){var t=this.create(i.Selector),r=!1;for(e&&(r=t.addChild(this._parseCombinator()));t.addChild(this._parseSimpleSelector());)r=!0,t.addChild(this._parseCombinator());return r?this.finish(t):null},e.prototype._parseDeclaration=function(e){var t=this.create(i.Declaration);return t.setProperty(this._parseProperty())?this.accept(r.TokenType.Colon)?(t.colonPosition=this.prevToken.offset,t.setValue(this._parseExpr())?(t.addChild(this._parsePrio()),this.peek(r.TokenType.SemiColon)&&(t.semicolonPosition=this.token.offset),this.finish(t)):this.finish(t,s.ParseError.PropertyValueExpected)):this.finish(t,s.ParseError.ColonExpected,[r.TokenType.Colon],e):null},e.prototype._tryParseCustomPropertyDeclaration=function(){if(!this.peekRegExp(r.TokenType.Ident,/^--/))return null;var e=this.create(i.CustomPropertyDeclaration);if(!e.setProperty(this._parseProperty()))return null;if(!this.accept(r.TokenType.Colon))return this.finish(e,s.ParseError.ColonExpected,[r.TokenType.Colon]);e.colonPosition=this.prevToken.offset;var t=this.mark();if(this.peek(r.TokenType.CurlyL)){var n=this.create(i.CustomPropertySet),o=this._parseDeclarations(this._parseRuleSetDeclaration.bind(this));if(n.setDeclarations(o)&&!o.isErroneous(!0)&&(n.addChild(this._parsePrio()),this.peek(r.TokenType.SemiColon)))return this.finish(n),e.setPropertySet(n),e.semicolonPosition=this.token.offset,this.finish(e);this.restoreAtMark(t)}var a=this._parseExpr();return a&&!a.isErroneous(!0)&&(this._parsePrio(),this.peek(r.TokenType.SemiColon))?(e.setValue(a),e.semicolonPosition=this.token.offset,this.finish(e)):(this.restoreAtMark(t),e.addChild(this._parseCustomPropertyValue()),e.addChild(this._parsePrio()),this.token.offset===e.colonPosition+1?this.finish(e,s.ParseError.PropertyValueExpected):this.finish(e))},e.prototype._parseCustomPropertyValue=function(){var e=this.create(i.Node),t=function(){return 0===n&&0===o&&0===a},n=0,o=0,a=0;e:for(;;){switch(this.token.type){case r.TokenType.SemiColon:case r.TokenType.Exclamation:if(t())break e;break;case r.TokenType.CurlyL:n++;break;case r.TokenType.CurlyR:if(--n<0){if(0===o&&0===a)break e;return this.finish(e,s.ParseError.LeftCurlyExpected)}break;case r.TokenType.ParenthesisL:o++;break;case r.TokenType.ParenthesisR:if(--o<0)return this.finish(e,s.ParseError.LeftParenthesisExpected);break;case r.TokenType.BracketL:a++;break;case r.TokenType.BracketR:if(--a<0)return this.finish(e,s.ParseError.LeftSquareBracketExpected);break;case r.TokenType.BadString:break e;case r.TokenType.EOF:var p=s.ParseError.RightCurlyExpected;return a>0?p=s.ParseError.RightSquareBracketExpected:o>0&&(p=s.ParseError.RightParenthesisExpected),this.finish(e,p)}this.consumeToken()}return this.finish(e)},e.prototype._tryToParseDeclaration=function(){var e=this.mark();return this._parseProperty()&&this.accept(r.TokenType.Colon)?(this.restoreAtMark(e),this._parseDeclaration()):(this.restoreAtMark(e),null)},e.prototype._parseProperty=function(){var e=this.create(i.Property),t=this.mark();return(this.acceptDelim("*")||this.acceptDelim("_"))&&this.hasWhitespace()?(this.restoreAtMark(t),null):e.setIdentifier(this._parsePropertyIdentifier())?this.finish(e):null},e.prototype._parsePropertyIdentifier=function(){return this._parseIdent()},e.prototype._parseCharset=function(){if(!this.peek(r.TokenType.Charset))return null;var e=this.create(i.Node);return this.consumeToken(),this.accept(r.TokenType.String)?this.accept(r.TokenType.SemiColon)?this.finish(e):this.finish(e,s.ParseError.SemiColonExpected):this.finish(e,s.ParseError.IdentifierExpected)},e.prototype._parseImport=function(){if(!this.peekKeyword("@import"))return null;var e=this.create(i.Import);return this.consumeToken(),e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral())?(this.peek(r.TokenType.SemiColon)||this.peek(r.TokenType.EOF)||e.setMedialist(this._parseMediaQueryList()),this.finish(e)):this.finish(e,s.ParseError.URIOrStringExpected)},e.prototype._parseNamespace=function(){if(!this.peekKeyword("@namespace"))return null;var e=this.create(i.Namespace);return this.consumeToken(),e.addChild(this._parseURILiteral())||(e.addChild(this._parseIdent()),e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral()))?this.accept(r.TokenType.SemiColon)?this.finish(e):this.finish(e,s.ParseError.SemiColonExpected):this.finish(e,s.ParseError.URIExpected,[r.TokenType.SemiColon])},e.prototype._parseFontFace=function(){if(!this.peekKeyword("@font-face"))return null;var e=this.create(i.FontFace);return this.consumeToken(),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._parseViewPort=function(){if(!this.peekKeyword("@-ms-viewport")&&!this.peekKeyword("@-o-viewport")&&!this.peekKeyword("@viewport"))return null;var e=this.create(i.ViewPort);return this.consumeToken(),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._parseKeyframe=function(){if(!this.peekRegExp(r.TokenType.AtKeyword,this.keyframeRegex))return null;var e=this.create(i.Keyframe),t=this.create(i.Node);return this.consumeToken(),e.setKeyword(this.finish(t)),"@-ms-keyframes"===t.getText()&&this.markError(t,s.ParseError.UnknownKeyword),e.setIdentifier(this._parseKeyframeIdent())?this._parseBody(e,this._parseKeyframeSelector.bind(this)):this.finish(e,s.ParseError.IdentifierExpected,[r.TokenType.CurlyR])},e.prototype._parseKeyframeIdent=function(){return this._parseIdent([i.ReferenceType.Keyframe])},e.prototype._parseKeyframeSelector=function(){var e=this.create(i.KeyframeSelector);if(!e.addChild(this._parseIdent())&&!this.accept(r.TokenType.Percentage))return null;for(;this.accept(r.TokenType.Comma);)if(!e.addChild(this._parseIdent())&&!this.accept(r.TokenType.Percentage))return this.finish(e,s.ParseError.PercentageExpected);return this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._tryParseKeyframeSelector=function(){var e=this.create(i.KeyframeSelector),t=this.mark();if(!e.addChild(this._parseIdent())&&!this.accept(r.TokenType.Percentage))return null;for(;this.accept(r.TokenType.Comma);)if(!e.addChild(this._parseIdent())&&!this.accept(r.TokenType.Percentage))return this.restoreAtMark(t),null;return this.peek(r.TokenType.CurlyL)?this._parseBody(e,this._parseRuleSetDeclaration.bind(this)):(this.restoreAtMark(t),null)},e.prototype._parseSupports=function(e){if(void 0===e&&(e=!1),!this.peekKeyword("@supports"))return null;var t=this.create(i.Supports);return this.consumeToken(),t.addChild(this._parseSupportsCondition()),this._parseBody(t,this._parseSupportsDeclaration.bind(this,e))},e.prototype._parseSupportsDeclaration=function(e){return void 0===e&&(e=!1),e?this._tryParseRuleset(!0)||this._tryToParseDeclaration()||this._parseStylesheetStatement(!0):this._parseStylesheetStatement(!1)},e.prototype._parseSupportsCondition=function(){var e=this.create(i.SupportsCondition);if(this.acceptIdent("not"))e.addChild(this._parseSupportsConditionInParens());else if(e.addChild(this._parseSupportsConditionInParens()),this.peekRegExp(r.TokenType.Ident,/^(and|or)$/i))for(var t=this.token.text.toLowerCase();this.acceptIdent(t);)e.addChild(this._parseSupportsConditionInParens());return this.finish(e)},e.prototype._parseSupportsConditionInParens=function(){var e=this.create(i.SupportsCondition);if(this.accept(r.TokenType.ParenthesisL))return e.lParent=this.prevToken.offset,e.addChild(this._tryToParseDeclaration())||this._parseSupportsCondition()?this.accept(r.TokenType.ParenthesisR)?(e.rParent=this.prevToken.offset,this.finish(e)):this.finish(e,s.ParseError.RightParenthesisExpected,[r.TokenType.ParenthesisR],[]):this.finish(e,s.ParseError.ConditionExpected);if(this.peek(r.TokenType.Ident)){var t=this.mark();if(this.consumeToken(),!this.hasWhitespace()&&this.accept(r.TokenType.ParenthesisL)){for(var n=1;this.token.type!==r.TokenType.EOF&&0!==n;)this.token.type===r.TokenType.ParenthesisL?n++:this.token.type===r.TokenType.ParenthesisR&&n--,this.consumeToken();return this.finish(e)}this.restoreAtMark(t)}return this.finish(e,s.ParseError.LeftParenthesisExpected,[],[r.TokenType.ParenthesisL])},e.prototype._parseMediaDeclaration=function(e){return void 0===e&&(e=!1),e?this._tryParseRuleset(!0)||this._tryToParseDeclaration()||this._parseStylesheetStatement(!0):this._parseStylesheetStatement(!1)},e.prototype._parseMedia=function(e){if(void 0===e&&(e=!1),!this.peekKeyword("@media"))return null;var t=this.create(i.Media);return this.consumeToken(),t.addChild(this._parseMediaQueryList())?this._parseBody(t,this._parseMediaDeclaration.bind(this,e)):this.finish(t,s.ParseError.MediaQueryExpected)},e.prototype._parseMediaQueryList=function(){var e=this.create(i.Medialist);if(!e.addChild(this._parseMediaQuery([r.TokenType.CurlyL])))return this.finish(e,s.ParseError.MediaQueryExpected);for(;this.accept(r.TokenType.Comma);)if(!e.addChild(this._parseMediaQuery([r.TokenType.CurlyL])))return this.finish(e,s.ParseError.MediaQueryExpected);return this.finish(e)},e.prototype._parseMediaQuery=function(e){var t=this.create(i.MediaQuery),n=!0,o=!1;if(!this.peek(r.TokenType.ParenthesisL)){if(this.acceptIdent("only")||this.acceptIdent("not"),!t.addChild(this._parseIdent()))return null;o=!0,n=this.acceptIdent("and")}for(;n;){if(!this.accept(r.TokenType.ParenthesisL))return o?this.finish(t,s.ParseError.LeftParenthesisExpected,[],e):null;if(!t.addChild(this._parseMediaFeatureName()))return this.finish(t,s.ParseError.IdentifierExpected,[],e);if(this.accept(r.TokenType.Colon)&&!t.addChild(this._parseExpr()))return this.finish(t,s.ParseError.TermExpected,[],e);if(!this.accept(r.TokenType.ParenthesisR))return this.finish(t,s.ParseError.RightParenthesisExpected,[],e);n=this.acceptIdent("and")}return this.finish(t)},e.prototype._parseMediaFeatureName=function(){return this._parseIdent()},e.prototype._parseMedium=function(){var e=this.create(i.Node);return e.addChild(this._parseIdent())?this.finish(e):null},e.prototype._parsePageDeclaration=function(){return this._parsePageMarginBox()||this._parseRuleSetDeclaration()},e.prototype._parsePage=function(){if(!this.peekKeyword("@page"))return null;var e=this.create(i.Page);if(this.consumeToken(),e.addChild(this._parsePageSelector()))for(;this.accept(r.TokenType.Comma);)if(!e.addChild(this._parsePageSelector()))return this.finish(e,s.ParseError.IdentifierExpected);return this._parseBody(e,this._parsePageDeclaration.bind(this))},e.prototype._parsePageMarginBox=function(){if(!this.peek(r.TokenType.AtKeyword))return null;var e=this.create(i.PageBoxMarginBox);return this.acceptOneKeyword(n.pageBoxDirectives)||this.markError(e,s.ParseError.UnknownAtRule,[],[r.TokenType.CurlyL]),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))},e.prototype._parsePageSelector=function(){if(!this.peek(r.TokenType.Ident)&&!this.peek(r.TokenType.Colon))return null;var e=this.create(i.Node);return e.addChild(this._parseIdent()),this.accept(r.TokenType.Colon)&&!e.addChild(this._parseIdent())?this.finish(e,s.ParseError.IdentifierExpected):this.finish(e)},e.prototype._parseDocument=function(){if(!this.peekKeyword("@-moz-document"))return null;var e=this.create(i.Document);return this.consumeToken(),this.resync([],[r.TokenType.CurlyL]),this._parseBody(e,this._parseStylesheetStatement.bind(this))},e.prototype._parseUnknownAtRule=function(){if(!this.peek(r.TokenType.AtKeyword))return null;var e=this.create(i.UnknownAtRule);e.addChild(this._parseUnknownAtRuleName());var t=0,n=0,o=0,a=0;e:for(;;){switch(this.token.type){case r.TokenType.SemiColon:if(0===n&&0===o&&0===a)break e;break;case r.TokenType.EOF:return n>0?this.finish(e,s.ParseError.RightCurlyExpected):a>0?this.finish(e,s.ParseError.RightSquareBracketExpected):o>0?this.finish(e,s.ParseError.RightParenthesisExpected):this.finish(e);case r.TokenType.CurlyL:t++,n++;break;case r.TokenType.CurlyR:if(n--,t>0&&0===n){if(this.consumeToken(),a>0)return this.finish(e,s.ParseError.RightSquareBracketExpected);if(o>0)return this.finish(e,s.ParseError.RightParenthesisExpected);break e}if(n<0){if(0===o&&0===a)break e;return this.finish(e,s.ParseError.LeftCurlyExpected)}break;case r.TokenType.ParenthesisL:o++;break;case r.TokenType.ParenthesisR:if(--o<0)return this.finish(e,s.ParseError.LeftParenthesisExpected);break;case r.TokenType.BracketL:a++;break;case r.TokenType.BracketR:if(--a<0)return this.finish(e,s.ParseError.LeftSquareBracketExpected)}this.consumeToken()}return e},e.prototype._parseUnknownAtRuleName=function(){var e=this.create(i.Node);return this.accept(r.TokenType.AtKeyword)?this.finish(e):e},e.prototype._parseOperator=function(){if(this.peekDelim("/")||this.peekDelim("*")||this.peekDelim("+")||this.peekDelim("-")||this.peek(r.TokenType.Dashmatch)||this.peek(r.TokenType.Includes)||this.peek(r.TokenType.SubstringOperator)||this.peek(r.TokenType.PrefixOperator)||this.peek(r.TokenType.SuffixOperator)||this.peekDelim("=")){var e=this.createNode(i.NodeType.Operator);return this.consumeToken(),this.finish(e)}return null},e.prototype._parseUnaryOperator=function(){if(!this.peekDelim("+")&&!this.peekDelim("-"))return null;var e=this.create(i.Node);return this.consumeToken(),this.finish(e)},e.prototype._parseCombinator=function(){if(this.peekDelim(">")){var e=this.create(i.Node);this.consumeToken();var t=this.mark();if(!this.hasWhitespace()&&this.acceptDelim(">")){if(!this.hasWhitespace()&&this.acceptDelim(">"))return e.type=i.NodeType.SelectorCombinatorShadowPiercingDescendant,this.finish(e);this.restoreAtMark(t)}return e.type=i.NodeType.SelectorCombinatorParent,this.finish(e)}if(this.peekDelim("+")){e=this.create(i.Node);return this.consumeToken(),e.type=i.NodeType.SelectorCombinatorSibling,this.finish(e)}if(this.peekDelim("~")){e=this.create(i.Node);return this.consumeToken(),e.type=i.NodeType.SelectorCombinatorAllSiblings,this.finish(e)}if(!this.peekDelim("/"))return null;e=this.create(i.Node);this.consumeToken();t=this.mark();if(!this.hasWhitespace()&&this.acceptIdent("deep")&&!this.hasWhitespace()&&this.acceptDelim("/"))return e.type=i.NodeType.SelectorCombinatorShadowPiercingDescendant,this.finish(e);this.restoreAtMark(t)},e.prototype._parseSimpleSelector=function(){var e=this.create(i.SimpleSelector),t=0;for(e.addChild(this._parseElementName())&&t++;(0===t||!this.hasWhitespace())&&e.addChild(this._parseSimpleSelectorBody());)t++;return t>0?this.finish(e):null},e.prototype._parseSimpleSelectorBody=function(){return this._parsePseudo()||this._parseHash()||this._parseClass()||this._parseAttrib()},e.prototype._parseSelectorIdent=function(){return this._parseIdent()},e.prototype._parseHash=function(){if(!this.peek(r.TokenType.Hash)&&!this.peekDelim("#"))return null;var e=this.createNode(i.NodeType.IdentifierSelector);if(this.acceptDelim("#")){if(this.hasWhitespace()||!e.addChild(this._parseSelectorIdent()))return this.finish(e,s.ParseError.IdentifierExpected)}else this.consumeToken();return this.finish(e)},e.prototype._parseClass=function(){if(!this.peekDelim("."))return null;var e=this.createNode(i.NodeType.ClassSelector);return this.consumeToken(),this.hasWhitespace()||!e.addChild(this._parseSelectorIdent())?this.finish(e,s.ParseError.IdentifierExpected):this.finish(e)},e.prototype._parseElementName=function(){var e=this.mark(),t=this.createNode(i.NodeType.ElementNameSelector);return t.addChild(this._parseNamespacePrefix()),t.addChild(this._parseSelectorIdent())||this.acceptDelim("*")?this.finish(t):(this.restoreAtMark(e),null)},e.prototype._parseNamespacePrefix=function(){var e=this.mark(),t=this.createNode(i.NodeType.NamespacePrefix);return!t.addChild(this._parseIdent())&&this.acceptDelim("*"),this.acceptDelim("|")?this.finish(t):(this.restoreAtMark(e),null)},e.prototype._parseAttrib=function(){if(!this.peek(r.TokenType.BracketL))return null;var e=this.create(i.AttributeSelector);return this.consumeToken(),e.setNamespacePrefix(this._parseNamespacePrefix()),e.setIdentifier(this._parseIdent())?(e.setOperator(this._parseOperator())&&(e.setValue(this._parseBinaryExpr()),this.acceptIdent("i")),this.accept(r.TokenType.BracketR)?this.finish(e):this.finish(e,s.ParseError.RightSquareBracketExpected)):this.finish(e,s.ParseError.IdentifierExpected)},e.prototype._parsePseudo=function(){var e=this,t=this._tryParsePseudoIdentifier();if(t){if(!this.hasWhitespace()&&this.accept(r.TokenType.ParenthesisL)){if(t.addChild(this.try((function(){var t=e.create(i.Node);if(!t.addChild(e._parseSelector(!1)))return null;for(;e.accept(r.TokenType.Comma)&&t.addChild(e._parseSelector(!1)););return e.peek(r.TokenType.ParenthesisR)?e.finish(t):void 0}))||this._parseBinaryExpr()),!this.accept(r.TokenType.ParenthesisR))return this.finish(t,s.ParseError.RightParenthesisExpected)}return this.finish(t)}return null},e.prototype._tryParsePseudoIdentifier=function(){if(!this.peek(r.TokenType.Colon))return null;var e=this.mark(),t=this.createNode(i.NodeType.PseudoSelector);return this.consumeToken(),this.hasWhitespace()?(this.restoreAtMark(e),null):(this.accept(r.TokenType.Colon)&&this.hasWhitespace()&&this.markError(t,s.ParseError.IdentifierExpected),t.addChild(this._parseIdent())||this.markError(t,s.ParseError.IdentifierExpected),t)},e.prototype._tryParsePrio=function(){var e=this.mark(),t=this._parsePrio();return t||(this.restoreAtMark(e),null)},e.prototype._parsePrio=function(){if(!this.peek(r.TokenType.Exclamation))return null;var e=this.createNode(i.NodeType.Prio);return this.accept(r.TokenType.Exclamation)&&this.acceptIdent("important")?this.finish(e):null},e.prototype._parseExpr=function(e){void 0===e&&(e=!1);var t=this.create(i.Expression);if(!t.addChild(this._parseBinaryExpr()))return null;for(;;){if(this.peek(r.TokenType.Comma)){if(e)return this.finish(t);this.consumeToken()}if(!t.addChild(this._parseBinaryExpr()))break}return this.finish(t)},e.prototype._parseNamedLine=function(){if(!this.peek(r.TokenType.BracketL))return null;var e=this.createNode(i.NodeType.GridLine);for(this.consumeToken();e.addChild(this._parseIdent()););return this.accept(r.TokenType.BracketR)?this.finish(e):this.finish(e,s.ParseError.RightSquareBracketExpected)},e.prototype._parseBinaryExpr=function(e,t){var r=this.create(i.BinaryExpression);if(!r.setLeft(e||this._parseTerm()))return null;if(!r.setOperator(t||this._parseOperator()))return this.finish(r);if(!r.setRight(this._parseTerm()))return this.finish(r,s.ParseError.TermExpected);r=this.finish(r);var n=this._parseOperator();return n&&(r=this._parseBinaryExpr(r,n)),this.finish(r)},e.prototype._parseTerm=function(){var e=this.create(i.Term);return e.setOperator(this._parseUnaryOperator()),e.setExpression(this._parseURILiteral())||e.setExpression(this._parseFunction())||e.setExpression(this._parseIdent())||e.setExpression(this._parseStringLiteral())||e.setExpression(this._parseNumeric())||e.setExpression(this._parseHexColor())||e.setExpression(this._parseOperation())||e.setExpression(this._parseNamedLine())?this.finish(e):null},e.prototype._parseOperation=function(){if(!this.peek(r.TokenType.ParenthesisL))return null;var e=this.create(i.Node);return this.consumeToken(),e.addChild(this._parseExpr()),this.accept(r.TokenType.ParenthesisR)?this.finish(e):this.finish(e,s.ParseError.RightParenthesisExpected)},e.prototype._parseNumeric=function(){if(this.peek(r.TokenType.Num)||this.peek(r.TokenType.Percentage)||this.peek(r.TokenType.Resolution)||this.peek(r.TokenType.Length)||this.peek(r.TokenType.EMS)||this.peek(r.TokenType.EXS)||this.peek(r.TokenType.Angle)||this.peek(r.TokenType.Time)||this.peek(r.TokenType.Dimension)||this.peek(r.TokenType.Freq)){var e=this.create(i.NumericValue);return this.consumeToken(),this.finish(e)}return null},e.prototype._parseStringLiteral=function(){if(!this.peek(r.TokenType.String)&&!this.peek(r.TokenType.BadString))return null;var e=this.createNode(i.NodeType.StringLiteral);return this.consumeToken(),this.finish(e)},e.prototype._parseURILiteral=function(){if(!this.peekRegExp(r.TokenType.Ident,/^url(-prefix)?$/i))return null;var e=this.mark(),t=this.createNode(i.NodeType.URILiteral);return this.accept(r.TokenType.Ident),this.hasWhitespace()||!this.peek(r.TokenType.ParenthesisL)?(this.restoreAtMark(e),null):(this.scanner.inURL=!0,this.consumeToken(),t.addChild(this._parseURLArgument()),this.scanner.inURL=!1,this.accept(r.TokenType.ParenthesisR)?this.finish(t):this.finish(t,s.ParseError.RightParenthesisExpected))},e.prototype._parseURLArgument=function(){var e=this.create(i.Node);return this.accept(r.TokenType.String)||this.accept(r.TokenType.BadString)||this.acceptUnquotedString()?this.finish(e):null},e.prototype._parseIdent=function(e){if(!this.peek(r.TokenType.Ident))return null;var t=this.create(i.Identifier);return e&&(t.referenceTypes=e),t.isCustomProperty=this.peekRegExp(r.TokenType.Ident,/^--/),this.consumeToken(),this.finish(t)},e.prototype._parseFunction=function(){var e=this.mark(),t=this.create(i.Function);if(!t.setIdentifier(this._parseFunctionIdentifier()))return null;if(this.hasWhitespace()||!this.accept(r.TokenType.ParenthesisL))return this.restoreAtMark(e),null;if(t.getArguments().addChild(this._parseFunctionArgument()))for(;this.accept(r.TokenType.Comma)&&!this.peek(r.TokenType.ParenthesisR);)t.getArguments().addChild(this._parseFunctionArgument())||this.markError(t,s.ParseError.ExpressionExpected);return this.accept(r.TokenType.ParenthesisR)?this.finish(t):this.finish(t,s.ParseError.RightParenthesisExpected)},e.prototype._parseFunctionIdentifier=function(){if(!this.peek(r.TokenType.Ident))return null;var e=this.create(i.Identifier);if(e.referenceTypes=[i.ReferenceType.Function],this.acceptIdent("progid")){if(this.accept(r.TokenType.Colon))for(;this.accept(r.TokenType.Ident)&&this.acceptDelim("."););return this.finish(e)}return this.consumeToken(),this.finish(e)},e.prototype._parseFunctionArgument=function(){var e=this.create(i.FunctionArgument);return e.setValue(this._parseExpr(!0))?this.finish(e):null},e.prototype._parseHexColor=function(){if(this.peekRegExp(r.TokenType.Hash,/^#([A-Fa-f0-9]{3}|[A-Fa-f0-9]{4}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$/g)){var e=this.create(i.HexColorValue);return this.consumeToken(),this.finish(e)}return null},e}();t.Parser=o}));