!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","./htmlScanner","../utils/arrays","../htmlLanguageTypes","../languageFacts/fact"],e)}((function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=e("./htmlScanner"),r=e("../utils/arrays"),a=e("../htmlLanguageTypes"),o=e("../languageFacts/fact"),i=function(){function e(e,t,n,r){this.start=e,this.end=t,this.children=n,this.parent=r,this.closed=!1}return Object.defineProperty(e.prototype,"attributeNames",{get:function(){return this.attributes?Object.keys(this.attributes):[]},enumerable:!0,configurable:!0}),e.prototype.isSameTag=function(e){return this.tag&&e&&this.tag.length===e.length&&this.tag.toLowerCase()===e},Object.defineProperty(e.prototype,"firstChild",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastChild",{get:function(){return this.children.length?this.children[this.children.length-1]:void 0},enumerable:!0,configurable:!0}),e.prototype.findNodeBefore=function(e){var t=r.findFirst(this.children,(function(t){return e<=t.start}))-1;if(t>=0){var n=this.children[t];if(e>n.start){if(e<n.end)return n.findNodeBefore(e);var a=n.lastChild;return a&&a.end===n.end?n.findNodeBefore(e):n}}return this},e.prototype.findNodeAt=function(e){var t=r.findFirst(this.children,(function(t){return e<=t.start}))-1;if(t>=0){var n=this.children[t];if(e>n.start&&e<=n.end)return n.findNodeAt(e)}return this},e}();t.Node=i,t.parse=function(e){for(var t=n.createScanner(e),r=new i(0,e.length,[],void 0),s=r,d=-1,l=null,f=null,c=t.scan();c!==a.TokenType.EOS;){switch(c){case a.TokenType.StartTagOpen:var u=new i(t.getTokenOffset(),e.length,[],s);s.children.push(u),s=u;break;case a.TokenType.StartTag:s.tag=t.getTokenText();break;case a.TokenType.StartTagClose:s.end=t.getTokenEnd(),s.startTagEnd=t.getTokenEnd(),s.tag&&o.isVoidElement(s.tag)&&s.parent&&(s.closed=!0,s=s.parent);break;case a.TokenType.StartTagSelfClose:s.parent&&(s.closed=!0,s.end=t.getTokenEnd(),s.startTagEnd=t.getTokenEnd(),s=s.parent);break;case a.TokenType.EndTagOpen:d=t.getTokenOffset(),l=null;break;case a.TokenType.EndTag:l=t.getTokenText().toLowerCase();break;case a.TokenType.EndTagClose:if(l){for(var p=s;!p.isSameTag(l)&&p.parent;)p=p.parent;if(p.parent){for(;s!==p;)s.end=d,s.closed=!1,s=s.parent;s.closed=!0,s.endTagStart=d,s.end=t.getTokenEnd(),s=s.parent}}break;case a.TokenType.AttributeName:f=t.getTokenText(),(g=s.attributes)||(s.attributes=g={}),g[f]=null;break;case a.TokenType.AttributeValue:var g,T=t.getTokenText();(g=s.attributes)&&f&&(g[f]=T,f=null)}c=t.scan()}for(;s.parent;)s.end=e.length,s.closed=!1,s=s.parent;return{roots:r.children,findNodeBefore:r.findNodeBefore.bind(r),findNodeAt:r.findNodeAt.bind(r)}}}));